<!doctype html>
<meta charset="utf-8">
<title>Meme Overlay</title>
<style>
  html,body{margin:0;background:transparent;overflow:hidden}
  #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  img{max-width:100vw;max-height:100vh;opacity:0;transition:opacity .25s}
  .show{opacity:1}
  #msg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
       color:#ddd;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:18px}
</style>
<div id="wrap"><img id="img" alt="meme"></div>
<div id="msg"></div>
<script>
(async () => {
  const qs   = new URLSearchParams(location.search);
  const cat  = (qs.get('cat') || 'memes').toLowerCase();    // anime | hmm | memes
  const mode = (qs.get('mode')|| 'reddit').toLowerCase();   // reddit | list
  const subsQ= (qs.get('subs')|| '').trim();                // optional override: "subA,subB"
  const DEBUG = qs.has('debug');

  const ALLOW = {
    anime: ['animemes','animememes','goodanimemes'],
    hmm:   ['blursedimages','hmm','hmmm','HolUp'],
    memes: ['dankmemes','memes','Bossfight']
  };

  // Accept only direct image hosts
  const allowDomains = ['i.redd.it','preview.redd.it','external-preview.redd.it','i.imgur.com'];

  const pick   = a => a[Math.floor(Math.random()*a.length)];
  const isImg  = u => /\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(u);
  const host   = u => { try { return new URL(u).host.toLowerCase(); } catch { return ''; } };
  const okDomain = u => allowDomains.some(d => host(u).endsWith(d));
  const unesc  = s => s.replace(/&amp;/g,'&');
  const showMsg = t => { if (!DEBUG) return; const m=document.getElementById('msg'); m.textContent=t; m.style.display='flex'; };

  async function fetchText(url){
    const r = await fetch(url, {cache:'no-store', headers:{'Accept':'text/plain, application/json'}});
    if(!r.ok) throw new Error('http '+r.status);
    return r.text();
  }

  // Optional curated list mode: memes/<cat>/index.txt (one URL per line)
  async function fromList(){
    const listURL = `memes/${encodeURIComponent(cat)}/index.txt`;
    const t = await fetchText(listURL);
    const urls = t.split(/\r?\n/).map(s=>s.trim())
      .filter(s=>s && !s.startsWith('#') && isImg(s) && okDomain(s));
    if (!urls.length) throw new Error('empty list');
    return pick(urls);
  }

  // Reddit mode: scan ALL allowed subs, collect images, then pick one
  async function fromReddit(){
    const subs = subsQ
      ? subsQ.split(',').map(s=>s.trim()).filter(Boolean)
      : (ALLOW[cat] || []);
    if (!subs.length) throw new Error('no subs for '+cat);

    const allImages = [];
    for (const sub of subs){
      // try two endpoints, prefer api.reddit.com with raw_json=1
      for (const ep of [
        s => `https://api.reddit.com/r/${encodeURIComponent(s)}/hot?limit=75&raw_json=1`,
        s => `https://www.reddit.com/r/${encodeURIComponent(s)}/hot.json?limit=75&raw_json=1`
      ]){
        try{
          const r = await fetch(ep(sub), {headers:{'Accept':'application/json'}});
          if (!r.ok) continue;
          const j = await r.json();
          const posts = (j.data?.children||[]).map(x=>x.data).filter(Boolean);

          for (const p of posts){
            if (p.over_18 || p.is_video || p.is_gallery) continue;

            let u = (p.url_overridden_by_dest || p.url || '').trim();
            if (!isImg(u) || !okDomain(u)){
              const prev = p.preview?.images?.[0]?.source?.url; // raw_json=1 gives clean URL
              if (prev) u = prev;
            }
            if (u && isImg(u) && okDomain(u)) allImages.push(u);
          }
          break; // this sub worked; go to next sub
        }catch{
          // try next endpoint, then next sub
        }
      }
    }
    if (!allImages.length) throw new Error('no reddit images');
    return pick(allImages);
  }

  // ---- choose source, fallback, and render one image ----
  let url = null;
  try {
    url = (mode==='list') ? await fromList() : await fromReddit();
  } catch(e) {
    if (DEBUG) showMsg('No image via '+mode+'. Trying list fallbackâ€¦');
    if (mode!=='list') { try { url = await fromList(); } catch {} }
  }

  if (!url) { showMsg('No image found. (Check adblock or try list mode)'); return; }

  const img = document.getElementById('img');
  img.onload  = () => img.classList.add('show');
  img.onerror = () => showMsg('Image failed to load.');
  img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); // cache-bust
})();
</script>
